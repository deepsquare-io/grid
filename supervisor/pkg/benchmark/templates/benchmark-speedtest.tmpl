{{- define "benchmark" -}}
#!/bin/bash

set -e

file="$(mktemp -t benchmark.XXXXXX)"
dir="$(dirname "$file")"

srun --container-image="registry-1.docker.io#library/python:slim" sh -c '
pip3 install --no-cache-dir archspec

apt update -yq && apt install -yq golang curl

curl -fsSL \
  -d "{\"microarch\":\"$(archspec cpu)\",\"os\":\"$(go env GOOS)\",\"arch\":\"$(go env GOARCH)\", \"cpu\":\"$(lscpu | grep 'Model name' | awk -F': ' '{print $2}' | xargs)\"}" \
  -X POST \
  -H "X-Secret: {{ .Secret }}" \
  -H 'Content-Type: application/json' \
  "https://{{ .SupervisorPublicAddress }}/benchmark/machine"
'

srun --container-mounts="$dir:$dir:rw" \
  --container-image="{{ .Image }}" \
  /usr/local/bin/speedtest --accept-license --accept-gdpr -f json-pretty > "$file"

curl -fsSL \
  --upload-file \
  "$file" \
  -H "X-Secret: {{ .Secret }}" \
  "https://{{ .SupervisorPublicAddress }}/benchmark/speedtest"
{{ end -}}
